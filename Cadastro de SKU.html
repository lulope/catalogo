<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de SKU</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    button {
      padding: 10px;
      border: none;
      cursor: pointer;
      margin: 5px;
      color: white;
    }
    #voltarMenuButton { background-color: #28a745; }
    #buscarButton { background-color: #28a745; }
    #addVariaButton { background-color: #17a2b8; }
    #salvarButton { background-color: #007bff; }
    #cancelButton { background-color: #dc3545; }
    
    .sku-list {
      margin-top: 20px;
    }
    .sku-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .sku-list th, .sku-list td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    /* Estilo do Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #ccc;
      width: 50%;
      text-align: center;
    }
    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <button id="voltarMenuButton" onclick="voltarMenu()">Voltar ao Menu</button>

  <h1>Cadastro de Variações de Produto</h1>

  <div>
    <label for="spu">Código SPU:</label>
    <input type="text" id="spu" placeholder="Código SPU" />
    <button id="buscarButton">Buscar</button>
  </div>

  <div id="skuList" class="sku-list"></div>

  <button id="addVariaButton" onclick="mostrarModal()" style="display:none;">Adicionar Variação</button>

  <!-- Modal para adicionar nova variação -->
  <div id="modalVaria" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2>Adicionar Nova Variação</h2>
      <label for="novoSku">SKU:</label>
      <input type="text" id="novoSku" placeholder="Código SKU">
      <label for="codCor">Código da Cor:</label>
      <input type="text" id="codCor" placeholder="Código da Cor">
      <label for="cor">Cor:</label>
      <input type="text" id="cor" placeholder="Nome da Cor">
      <label for="gradeInicio">Grade Inicial:</label>
      <input type="text" id="gradeInicio" placeholder="Ex: P">
      <label for="gradeFim">Grade Final:</label>
      <input type="text" id="gradeFim" placeholder="Ex: GG">
      <label for="valor">Valor:</label>
      <input type="number" id="valor" placeholder="Preço">
      <br><br>
      <button id="salvarButton" onclick="salvarVaria()">Salvar</button>
      <button id="cancelButton" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBlLB2K6Sj9kQ9pVAu7rt-Db0jsC-hyvmU",
      authDomain: "applulope.firebaseapp.com",
      databaseURL: "https://applulope-default-rtdb.firebaseio.com",
      projectId: "applulope",
      storageBucket: "applulope.appspot.com",
      messagingSenderId: "327504288727",
      appId: "1:327504288727:web:96e7bfc239cf9337c9c992"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let spuAtual = "";

    document.getElementById('buscarButton').addEventListener('click', function() {
      const spu = document.getElementById('spu').value.trim();
      if (!spu) return alert("Digite um código SPU.");

      spuAtual = spu;

      const spuRef = ref(database, `Produtos/SPU/${spu}`);
      get(spuRef).then(snapshot => {
        const skuList = document.getElementById('skuList');
        skuList.innerHTML = "";

        if (snapshot.exists()) {
          const skuData = snapshot.val();
          if (skuData.SKU) {
            let htmlContent = `
              <table>
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Código Cor</th>
                    <th>Cor</th>
                    <th>Grade</th>
                    <th>Valor</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>`;

            Object.keys(skuData.SKU).forEach(skuKey => {
                const skuItem = skuData.SKU[skuKey];
                htmlContent += `
                    <tr id="sku-${skuKey}">
                        <td>${skuKey}</td>
                        <td>${skuItem.CodCor}</td>
                        <td>${skuItem.Cor}</td>
                        <td>${skuItem.Inicio} ao ${skuItem.Fim}</td>
                        <td>R$ ${skuItem.Valor}</td>
                        <td>
                            <button id="editarButton" onclick="editarSKU('${spu}', '${skuKey}')">Editar</button>
                            <button onclick="excluirSKU('${spu}', '${skuKey}')" style="background-color: #dc3545;">Excluir</button>
                        </td>
                    </tr>`;
            });

            htmlContent += `</tbody></table>`;
            skuList.innerHTML = htmlContent;
            document.getElementById('addVariaButton').style.display = "block";
          } else {
            skuList.innerHTML = "<p>Nenhuma variação encontrada para este SPU.</p>";
          }
        } else {
          skuList.innerHTML = "<p>Este SPU não foi cadastrado.</p>";
          document.getElementById('addVariaButton').style.display = "none";
        }
      });
    });

    window.mostrarModal = function() {
      document.getElementById('modalVaria').style.display = "block";
    };

    window.fecharModal = function() {
      document.getElementById('modalVaria').style.display = "none";
    };

    window.salvarVaria = function() {
      const novoSku = document.getElementById('novoSku').value;
      const codCor = document.getElementById('codCor').value;
      const cor = document.getElementById('cor').value;
      const inicio = document.getElementById('gradeInicio').value;
      const fim = document.getElementById('gradeFim').value;
      const valor = document.getElementById('valor').value;

      if (!novoSku || !codCor || !cor || !inicio || !fim || !valor) {
        alert("Preencha todos os campos!");
        return;
      }

      set(ref(database, `Produtos/SPU/${spuAtual}/SKU/${novoSku}`), {
        CodCor: codCor,
        Cor: cor,
        Inicio: inicio,
        Fim: fim,
        Valor: valor
      }).then(() => {
        alert("Variação adicionada!");
        fecharModal();
        document.getElementById('buscarButton').click();
      });
    };

  </script>

</body>
</html>
