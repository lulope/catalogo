<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBlLB2K6Sj9kQ9pVAu7rt-Db0jsC-hyvmU",
            authDomain: "applulope.firebaseapp.com",
            databaseURL: "https://applulope-default-rtdb.firebaseio.com",
            projectId: "applulope",
            storageBucket: "applulope.appspot.com",
            messagingSenderId: "327504288727",
            appId: "1:327504288727:web:96e7bfc239cf9337c9c992",
            measurementId: "G-KNTVRE6P08"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const produtosRef = ref(database, "Produtos/SPU");
        const categoriasRef = ref(database, "Produtos/Categorias");

        function carregarCategorias() {
            get(categoriasRef).then((snapshot) => {
                const categoriasSelect = document.getElementById("categorias");
                categoriasSelect.innerHTML = "<option value=''>Selecione a Categoria</option>";
                
                const subcategoriasSelect = document.getElementById("subcategorias");
                subcategoriasSelect.innerHTML = "<option value=''>Selecione a Subcategoria</option>";
                
                const categorias = snapshot.val();
                if (categorias) {
                    for (let categoria in categorias) {
                        let option = document.createElement("option");
                        option.value = categoria;
                        option.textContent = categoria;
                        categoriasSelect.appendChild(option);
                    }
                }
            });
        }

        document.getElementById("categorias").addEventListener("change", function() {
            const categoriaSelecionada = this.value;
            const subcategoriasSelect = document.getElementById("subcategorias");
            subcategoriasSelect.innerHTML = "<option value=''>Selecione a Subcategoria</option>";

            if (categoriaSelecionada) {
                get(ref(database, `Produtos/Categorias/${categoriaSelecionada}/Subcategoria`)).then(snapshot => {
                    const subcategorias = snapshot.val();
                    if (subcategorias) {
                        for (let subcategoria in subcategorias) {
                            let option = document.createElement("option");
                            option.value = subcategoria;
                            option.textContent = subcategoria;
                            subcategoriasSelect.appendChild(option);
                        }
                    }
                });
            }
        });

        function carregarProdutos() {
            const categoriaSelecionada = document.getElementById("categorias").value;
            const subcategoriaSelecionada = document.getElementById("subcategorias").value;
            const spuBusca = document.getElementById("spuBusca").value.trim().toLowerCase();

            get(produtosRef).then((snapshot) => {
                const catalogoDiv = document.getElementById("catalogo");
                const produtos = snapshot.val();
                catalogoDiv.innerHTML = "";

                if (produtos) {
                    for (let spu in produtos) {
                        let produto = produtos[spu];
                        let categoria = produto.Categoria || "Indefinida";
                        let subcategoria = produto.Subcategoria || "Indefinida";

                        if (produto.SKU) {
                            if ((categoriaSelecionada === "" || categoria === categoriaSelecionada) &&
                                (subcategoriaSelecionada === "" || subcategoria === subcategoriaSelecionada) &&
                                (spuBusca === "" || spu.toLowerCase().includes(spuBusca))) {

                                let spuDiv = document.createElement("div");
                                spuDiv.classList.add("spu");
                                spuDiv.innerHTML = `
                                    <h2>${spu} | ${categoria} | ${subcategoria}</h2>
                                    <div class="sku-container">
                                        <div class="sku-scroll"></div>
                                    </div>
                                `;

                                let skuScroll = spuDiv.querySelector(".sku-scroll");

                                for (let sku in produto.SKU) {
                                    let skuData = produto.SKU[sku];
                                    let valor = skuData.Valor ? `R$ ${skuData.Valor}` : "Indisponível";
                                    let imagemPath = `CATÁLOGO/${sku}.jpg`;

                                    let tamanhoInicial = skuData.Inicio || "Indefinido";
                                    let tamanhoFinal = skuData.Fim || "Indefinido";
                                    let grade = `${tamanhoInicial} ao ${tamanhoFinal}`;

                                    let cor = skuData.Cor || "Indefinida";

                                    let skuDiv = document.createElement("div");
                                    skuDiv.classList.add("sku");
                                    skuDiv.innerHTML = `
                                        <h3>${sku}</h3>
                                        <div class="img-container">
                                            <img src="" id="img-${sku}" class="img-placeholder" alt="Imagem do Produto">
                                        </div>
                                        <p><strong>Cor:</strong> ${cor}</p>
                                        <p><strong>Grade:</strong> ${grade}</p>
                                        <p><strong>Preço:</strong> ${valor}</p>
                                    `;
                                    skuScroll.appendChild(skuDiv);

                                    const imageRef = storageRef(storage, imagemPath);
                                    getDownloadURL(imageRef)
                                        .then((url) => {
                                            document.getElementById(`img-${sku}`).src = url;
                                        })
                                        .catch(() => {
                                            document.getElementById(`img-${sku}`).src = "caminho/para/imagem/fallback.jpg";
                                        });
                                }
                                catalogoDiv.appendChild(spuDiv);
                            }
                        }
                    }
                }
            });
        }

        document.getElementById("categorias").addEventListener("change", carregarProdutos);
        document.getElementById("subcategorias").addEventListener("change", carregarProdutos);
        document.getElementById("spuBusca").addEventListener("input", carregarProdutos);

        document.addEventListener("DOMContentLoaded", () => {
            carregarCategorias();
            carregarProdutos();
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffe0f0;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            color: #d63384;
        }
        .filters {
            text-align: center;
            margin: 20px;
        }
        select, input {
            padding: 10px;
            margin: 5px;
        }
        .spu {
            background: white;
            padding: 20px;
            margin: 10px auto;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            max-width: 90%;
        }
        .sku-container {
            overflow-x: auto;
            white-space: nowrap;
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }
        .sku-scroll {
            display: flex;
            gap: 10px;
        }
        .sku {
            background: #fff0f5;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            width: 200px;
            flex-shrink: 0;
        }
        .img-container {
            width: 100%;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            border-radius: 8px;
        }
        .img-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <h1>Catálogo de Produtos</h1>
    <div class="filters">
        <select id="categorias"></select>
        <select id="subcategorias"></select>
        <input type="text" id="spuBusca" placeholder="Buscar por SPU">
    </div>
    <div id="catalogo"></div>
</body>
</html>
