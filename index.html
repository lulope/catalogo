<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <!-- Desabilita o zoom padrão da página para que o pinch-zoom seja aplicado apenas à imagem -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Catálogo de Produtos</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
    import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBlLB2K6Sj9kQ9pVAu7rt-Db0jsC-hyvmU",
      authDomain: "applulope.firebaseapp.com",
      databaseURL: "https://applulope-default-rtdb.firebaseio.com",
      projectId: "applulope",
      storageBucket: "applulope.appspot.com",
      messagingSenderId: "327504288727",
      appId: "1:327504288727:web:96e7bfc239cf9337c9c992",
      measurementId: "G-KNTVRE6P08"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);
    const produtosRef = ref(database, "Produtos/SPU");
    const categoriasRef = ref(database, "Produtos/Categorias");

    // Carrega as categorias e popula o select
    function carregarCategorias() {
      get(categoriasRef).then((snapshot) => {
        const categoriasSelect = document.getElementById("categorias");
        categoriasSelect.innerHTML = "<option value=''>Selecione a Categoria</option>";
        
        const subcategoriasSelect = document.getElementById("subcategorias");
        subcategoriasSelect.innerHTML = "<option value=''>Selecione a Subcategoria</option>";
        
        const categorias = snapshot.val();
        if (categorias) {
          for (let categoria in categorias) {
            let option = document.createElement("option");
            option.value = categoria;
            option.textContent = categoria;
            categoriasSelect.appendChild(option);
          }
        }
      });
    }

    // Carrega as subcategorias da categoria selecionada
    document.getElementById("categorias").addEventListener("change", function() {
      const categoriaSelecionada = this.value;
      const subcategoriasSelect = document.getElementById("subcategorias");
      subcategoriasSelect.innerHTML = "<option value=''>Selecione a Subcategoria</option>";

      if (categoriaSelecionada) {
        get(ref(database, `Produtos/Categorias/${categoriaSelecionada}/Subcategoria`)).then(snapshot => {
          const subcategorias = snapshot.val();
          if (subcategorias) {
            for (let subcategoria in subcategorias) {
              let option = document.createElement("option");
              option.value = subcategoria;
              option.textContent = subcategoria;
              subcategoriasSelect.appendChild(option);
            }
          }
        });
      }
      carregarProdutos();
    });

    // Carrega os produtos de acordo com os filtros
    function carregarProdutos() {
      const categoriaSelecionada = document.getElementById("categorias").value;
      const subcategoriaSelecionada = document.getElementById("subcategorias").value;
      const spuBusca = document.getElementById("spuBusca").value.trim().toLowerCase();

      get(produtosRef).then((snapshot) => {
        const catalogoDiv = document.getElementById("catalogo");
        const produtos = snapshot.val();
        catalogoDiv.innerHTML = "";

        if (produtos) {
          for (let spu in produtos) {
            let produto = produtos[spu];
            // Só exibe se houver variações (SKU)
            if (!produto.SKU) continue;

            let categoria = produto.Categoria || "";
            let subcategoria = produto.Subcategoria || "";

            // Aplica os filtros
            if ((categoriaSelecionada && categoria !== categoriaSelecionada) ||
                (subcategoriaSelecionada && subcategoria !== subcategoriaSelecionada) ||
                (spuBusca && !spu.toLowerCase().includes(spuBusca))) {
              continue;
            }

            // Cabeçalho: se não houver subcategoria, exibe apenas "SPU | CATEGORIA"
            let headerText = `${spu} | ${categoria}`;
            if (subcategoria) headerText += ` | ${subcategoria}`;

            let spuDiv = document.createElement("div");
            spuDiv.classList.add("spu");
            spuDiv.innerHTML = `
              <h2>${headerText}</h2>
              <div class="sku-container">
                <div class="sku-scroll"></div>
              </div>
            `;

            let skuScroll = spuDiv.querySelector(".sku-scroll");

            for (let sku in produto.SKU) {
              let skuData = produto.SKU[sku];
              let valor = skuData.Valor ? `R$ ${skuData.Valor}` : "Indisponível";
              let imagemPath = `CATÁLOGO/${sku}.jpg`;

              let tamanhoInicial = skuData.Inicio || "Indefinido";
              let tamanhoFinal = skuData.Fim || "Indefinido";
              let grade = `${tamanhoInicial} ao ${tamanhoFinal}`;

              let cor = skuData.Cor || "Indefinida";

              let skuDiv = document.createElement("div");
              skuDiv.classList.add("sku");
              skuDiv.innerHTML = `
                <h3>${sku}</h3>
                <div class="img-container">
                  <img src="" id="img-${sku}" class="img-placeholder" alt="Imagem do Produto" onclick="abrirImagem(this)">
                </div>
                <p><strong>Cor:</strong> ${cor}</p>
                <p><strong>Grade:</strong> ${grade}</p>
                <p><strong>Preço:</strong> ${valor}</p>
              `;
              skuScroll.appendChild(skuDiv);

              const imageRef = storageRef(storage, imagemPath);
              getDownloadURL(imageRef)
                .then((url) => {
                  document.getElementById(`img-${sku}`).src = url;
                })
                .catch(() => {
                  document.getElementById(`img-${sku}`).src = "caminho/para/imagem/fallback.jpg";
                });
            }
            catalogoDiv.appendChild(spuDiv);
          }
        }
      });
    }

    document.getElementById("subcategorias").addEventListener("change", carregarProdutos);
    document.getElementById("spuBusca").addEventListener("input", carregarProdutos);

    // Função para abrir o modal com a imagem e iniciar o pinch-to-zoom
    window.abrirImagem = function (imgElement) {
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImg");
      modal.style.display = "flex";
      modalImg.src = imgElement.src;
      modalImg.style.transform = "scale(1)";
      currentScale = 1;
    };

    // Função para fechar o modal
    window.fecharModal = function () {
      document.getElementById("imageModal").style.display = "none";
    };

    // Função auxiliar para calcular a distância entre dois toques
    function getDistance(touch1, touch2) {
      const dx = touch2.clientX - touch1.clientX;
      const dy = touch2.clientY - touch1.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // Variáveis para controle do pinch-to-zoom
    let initialDistance = 0;
    let currentScale = 1;
    const modalImg = document.getElementById("modalImg");

    // Adiciona os eventos de toque para o pinch-to-zoom no modal
    function adicionarEventosPinch() {
      const modalImg = document.getElementById("modalImg");
      modalImg.addEventListener("touchstart", function(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          initialDistance = getDistance(e.touches[0], e.touches[1]);
        }
      }, { passive: false });

      modalImg.addEventListener("touchmove", function(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          const newDistance = getDistance(e.touches[0], e.touches[1]);
          const scaleFactor = newDistance / initialDistance;
          modalImg.style.transform = "scale(" + (currentScale * scaleFactor) + ")";
        }
      }, { passive: false });

      modalImg.addEventListener("touchend", function(e) {
        if (e.touches.length < 2) {
          // Atualiza o currentScale com o valor final aplicado
          const computedStyle = window.getComputedStyle(modalImg);
          const transform = computedStyle.getPropertyValue("transform");
          if (transform && transform !== "none") {
            const values = transform.split('(')[1].split(')')[0].split(',');
            currentScale = parseFloat(values[0]);
          }
          initialDistance = 0;
        }
      }, { passive: false });
    }

    document.addEventListener("DOMContentLoaded", () => {
      carregarCategorias();
      carregarProdutos();
      adicionarEventosPinch();
    });
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffe0f0;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      color: #d63384;
    }
    .filters {
      text-align: center;
      margin: 20px;
    }
    select, input {
      padding: 10px;
      margin: 5px;
    }
    .spu {
      background: white;
      padding: 20px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      max-width: 90%;
    }
    .sku-container {
      overflow-x: auto;
      white-space: nowrap;
      display: flex;
      gap: 10px;
      padding: 10px 0;
    }
    .sku-scroll {
      display: flex;
      gap: 10px;
    }
    .sku {
      background: #fff0f5;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      width: 200px;
      flex-shrink: 0;
    }
    .img-container {
      width: 100%;
      height: 150px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      border-radius: 8px;
    }
    .img-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: pointer;
    }
    /* Modal de imagem */
    #imageModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }
    #modalContent {
      position: relative;
    }
    #modalImg {
      max-width: 90vw;
      max-height: 90vh;
      transition: transform 0.2s;
    }
    #closeModal {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: red;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <h1>Catálogo de Produtos</h1>
  <div class="filters">
    <select id="categorias"></select>
    <select id="subcategorias"></select>
    <input type="text" id="spuBusca" placeholder="Buscar por SPU">
  </div>
  <div id="catalogo"></div>

  <!-- Modal com imagem em tela cheia e botão de fechar posicionado no canto superior direito -->
  <div id="imageModal">
    <div id="modalContent">
      <img id="modalImg">
      <button id="closeModal" onclick="fecharModal()">Fechar</button>
    </div>
  </div>
</body>
</html>
